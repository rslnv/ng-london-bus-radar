@let details = details$ | async;
@if (details) {
  <div class="header">
    @switch (details.state) {
      @case ('loading') {
        <app-loading />
      }
      @case ('error') {
        <app-error
          (onRefresh)="detailsRefresherSubject.next()"
          [errorData]="details.error"
        />
      }
      @case ('done') {
        <app-bus-stop [stop]="details.data" [hideLines]="true" />
      }
    }

    <button
      mat-mini-fab
      aria-label="Refresh arrivals"
      (click)="refresherSubject.next()"
    >
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  @if (details.state === 'done') {
    <app-line-filter
      [lines]="details.data.lines"
      [preSelectedLine]="lineId()"
      (filter)="lineFilter.set($event)"
    />
  }
}

@if (lineFilter()) {
  <div class="view-filter">
    <mat-button-toggle-group
      hideSingleSelectionIndicator="true"
      [(ngModel)]="arrivalTimeSpan"
    >
      <mat-button-toggle value="live">Live</mat-button-toggle>
      <mat-button-toggle value="timetable">Timetable</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
}

@let arrivals = arrivals$ | async;
@if (arrivals && (!lineFilter() || arrivalTimeSpan() === 'live')) {
  <div class="content">
    @switch (arrivals.state) {
      @case ('error') {
        <app-error
          (onRefresh)="refresherSubject.next()"
          [errorData]="arrivals.error"
        />
      }
      @case ('done') {
        @for (arrival of arrivals.data; track arrival.id; let last = $last) {
          <app-bus-arrival [item]="arrival" />
        } @empty {
          <div>No results</div>
        }
      }
    }
  </div>
} @else if (lineFilter()) {
  <app-stop-timetable [stopId]="stopId()" [lineId]="lineFilter()!" />
}
