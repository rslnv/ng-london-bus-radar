import{a as ot}from"./chunk-IWTH6EZB.js";import{b as it,c as nt,d as at,e as rt,f as pt,g as ct}from"./chunk-I2XKUEJU.js";import{$ as M,B as v,Bb as O,Cb as j,D as E,E as P,I as B,Ia as d,Ja as u,Lb as $,M as I,Ma as w,N as F,Na as S,O as N,Oa as r,Pa as c,Qa as l,R,Ra as _,U as A,Va as b,Xa as C,Y as V,Yb as U,Za as m,Zb as W,aa as h,bd as Y,dd as Z,fd as tt,gd as et,hc as K,j as f,kb as H,lc as Q,mb as g,na as p,ob as G,p as z,qc as X,s,sb as J,tb as q,ub as y,va as x,xb as L,yb as k,zb as D}from"./chunk-4OSKGQCA.js";var ut=()=>[17],mt=(e,i)=>[e,i],_t=e=>[e,51.2,.4,51.8],Ct=()=>({preserveDrawingBuffer:!0}),gt=()=>({enableHighAccuracy:!0}),ft=(e,i)=>i.id;function vt(e,i){if(e&1&&g(0),e&2){let t=m().$implicit;G(" ",t.stopLetter," ")}}function Mt(e,i){e&1&&(c(0,"mat-icon"),g(1,"directions_bus"),l())}function ht(e,i){if(e&1){let t=b();c(0,"mgl-marker",4)(1,"div",5),C("click",function(){let n=M(t).$implicit,a=m(2);return h(a.click(n.id))}),d(2,vt,1,1)(3,Mt,2,0,"mat-icon"),l()()}if(e&2){let t=i.$implicit;r("lngLat",D(2,mt,t.longitude,t.latitude)),p(2),u(t.stopLetter?2:3)}}function xt(e,i){if(e&1&&w(0,ht,4,5,"mgl-marker",4,ft),e&2){let t=m();S(t.stops())}}var st=(()=>{class e{startingLocation=$.required();stops=$();map=null;moveSubject=new f;mapCenter=K(this.moveSubject.pipe(v(t=>!!this.map),s(t=>{let o=this.map.getCenter().wrap();return{latitude:+o.lat.toFixed(3),longitude:+o.lng.toFixed(3),zoom:this.map.getZoom()}})));click(t){console.log("Clicking stop",t)}static \u0275fac=function(o){return new(o||e)};static \u0275cmp=x({type:e,selectors:[["app-map-view"]],inputs:{startingLocation:[1,"startingLocation"],stops:[1,"stops"]},outputs:{mapCenter:"mapCenter"},decls:5,vars:18,consts:[[3,"mapLoad","move","zoom","center","maxBounds","attributionControl","canvasContextAttributes"],["mglAttribution","","position","top-right",3,"compact"],["mglGeolocate","","position","bottom-right",3,"positionOptions"],["mglNavigation","","position","bottom-right"],[3,"lngLat"],[1,"marker",3,"click"]],template:function(o,n){if(o&1&&(c(0,"mgl-map",0),C("mapLoad",function(dt){return n.map=dt,n.moveSubject.next()})("move",function(){return n.moveSubject.next()}),_(1,"mgl-control",1)(2,"mgl-control",2)(3,"mgl-control",3),d(4,xt,2,0),l()),o&2){let a;H("https://tiles.openfreemap.org/styles/bright"),r("zoom",L(10,ut))("center",D(11,mt,n.startingLocation().longitude,n.startingLocation().latitude))("maxBounds",k(14,_t,-.7))("attributionControl",!1)("canvasContextAttributes",L(16,Ct)),p(),r("compact",!0),p(),r("positionOptions",L(17,gt)),p(2),u((a=n.stops())!=null&&a.length?4:-1)}},dependencies:[nt,it,at,pt,ct,Y,rt],styles:["mgl-map[_ngcontent-%COMP%]{width:100%;height:100%}.marker[_ngcontent-%COMP%]{min-width:3em;height:3em;display:flex;align-items:center;justify-content:center;background-color:#c33;color:#fff;font-weight:700;border-radius:50%;font-size:.8em}"]})}return e})();var T=(()=>{class e{_location={latitude:51.501069694992935,longitude:-.12410468234293585};constructor(){try{let t=localStorage.getItem("mapLocation");this._location=JSON.parse(t??"")}catch{}}set location(t){localStorage.setItem("mapLocation",JSON.stringify(t)),this._location=t}get location(){return this._location}static zoomToRadius(t){let o=Math.min(18,Math.floor(t));return o=Math.max(14,o),500-(o-14)*100}static latLonRadiusComparer=(t,o)=>Math.abs(t.latitude-o.latitude)<.001&&Math.abs(t.longitude-o.longitude)<.001&&t.radius>=o.radius;static \u0275fac=function(o){return new(o||e)};static \u0275prov=A({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();var wt=e=>["/stop",e],St=(e,i)=>i.id;function bt(e,i){if(e&1&&(c(0,"a",3),_(1,"app-bus-stop",4),l()),e&2){let t=i.$implicit;r("routerLink",k(2,wt,t.id)),p(),r("stop",t)}}function yt(e,i){e&1&&(c(0,"div"),g(1,"No results"),l())}function Lt(e,i){if(e&1&&w(0,bt,2,4,"a",3,St,!1,yt,2,0,"div"),e&2){m(2);let t=y(0);S(t.data)}}function kt(e,i){e&1&&_(0,"app-loading")}function Tt(e,i){if(e&1&&_(0,"app-error",2),e&2){m(2);let t=y(0);r("errorData",t.error)}}function Ft(e,i){if(e&1){let t=b();c(0,"app-map-view",0),O(1,"async"),C("mapCenter",function(n){M(t);let a=m();return h(a.moveSubject.next(n))}),l(),c(2,"div",1),d(3,Lt,3,1)(4,kt,1,0,"app-loading")(5,Tt,1,1,"app-error",2),l()}if(e&2){let t=m(),o=y(0);r("startingLocation",t.startingLocation)("stops",j(1,3,t.markers$)),p(3),u(o.state==="done"?3:o.state==="loading"?4:o.state==="error"?5:-1)}}var Xt=(()=>{class e{stopService=V(ot);mapHelperService=V(T);startingLocation=this.mapHelperService.location;moveSubject=new f;viewModel$=this.moveSubject.pipe(P(500),s(t=>({latitude:t.latitude,longitude:t.longitude,radius:T.zoomToRadius(t.zoom)})),B(T.latLonRadiusComparer),R(t=>this.mapHelperService.location={latitude:t.latitude,longitude:t.longitude}),N(t=>this.stopService.findByLocation(t.latitude,t.longitude,t.radius).pipe(s(o=>({state:"done",data:o})),E(o=>z({state:"error",error:o})),F({state:"loading"}))),F({state:"loading"}),I({bufferSize:1,refCount:!0}));markers$=this.viewModel$.pipe(v(t=>t.state==="done"),s(t=>t.data));static \u0275fac=function(o){return new(o||e)};static \u0275cmp=x({type:e,selectors:[["app-map-search"]],decls:3,vars:4,consts:[[3,"mapCenter","startingLocation","stops"],[1,"content"],[3,"errorData"],[3,"routerLink"],[3,"stop"]],template:function(o,n){if(o&1&&(J(0),O(1,"async"),d(2,Ft,6,5)),o&2){let a=q(j(1,1,n.viewModel$));p(2),u(a?2:-1)}},dependencies:[st,W,X,Q,et,tt,Z,U],styles:["app-map-view[_ngcontent-%COMP%]{display:block;width:100%;height:500px}.content[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{margin:.7em 0;display:block}.content[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{text-decoration:none;color:inherit}.content[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{text-align:center}"]})}return e})();export{Xt as MapSearchComponent};
